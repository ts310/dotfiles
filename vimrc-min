" vim: nowrap fdm=marker
 
" Initial settings {{{1
" ---------------------------------------------------------
  set nocompatible
  set encoding=utf-8
  let mapleader = ","
  " Shortcut for edit/source vim runtime configuration in command
  command! Ev edit $MYVIMRC
  command! Rv source $MYVIMRC
" }}}

" Load plugins {{{1
" ---------------------------------------------------------
  filetype off                 
  runtime macros/matchit.vim
  runtime ftplugin/man.vim
  set rtp+=~/.vim/vundle.git/  
  call vundle#rc()             
  Bundle 'gmarik/vundle'
  "Bundle 'Shougo/unite.vim'
  "Bundle 'Shougo/ref.vim'
  "Bundle 'Shougo/neocomplcache'
  "Bundle 'Shougo/vimproc'
  Bundle 'mileszs/ack.vim'
  Bundle 'scrooloose/nerdtree'
  Bundle 'tyok/nerdtree-ack'
  Bundle 'vsushkov/vim-nerdtree-and-ack'
  Bundle 'scrooloose/nerdcommenter'
  Bundle 'tpope/vim-surround'
  Bundle 'tpope/vim-repeat'
  Bundle 'tpope/vim-fugitive'
  Bundle 'tpope/vim-git'
  Bundle 'tpope/vim-rails'
  Bundle 'tpope/vim-unimpaired'
  Bundle 'tpope/vim-abolish'
  Bundle 'tpope/vim-commentary'
  Bundle 'vim-scripts/taglist.vim'
  Bundle 'vim-scripts/YankRing.vim'
  Bundle 'vim-scripts/Align'
  Bundle 'vim-scripts/ZenCoding.vim'
  Bundle 'vim-scripts/matchit.zip'
  Bundle 'vim-scripts/AutoComplPop'
  Bundle 'mileszs/ack.vim'
  Bundle 'wincent/Command-T'
  "Bundle 'ervandew/supertab'
  Bundle 'scrooloose/snipmate-snippets'
  Bundle 'thinca/vim-quickrun'
  Bundle 'kogakure/vim-sparkup'
  Bundle 'groenewege/vim-less'
  Bundle 'Color-Sampler-Pack'
  Bundle 'php.vim'
  Bundle 'phpcomplete.vim'
  Bundle 'sudo.vim'
  "Bundle 'Source-Explorer-srcexpl.vim'
  "Bundle 'ctags.vim'
  "Bundle 'vim-diff'
  "Bundle 'php-doc'
  "Bundle 'cocoa.vim'
  "Bundle 'Match-Bracket-for-Objective-C'
  "Bundle 'sql_iabbr-2'
  Bundle 'SQLUtilities'
  "Bundle 'svn-diff.vim'
  "Bundle 'kmnk/vim-unite-svn'
  "Bundle 'XML-Folding'
  "Bundle 'intuited/vim-shell_complete'
  "Bundle 'vimshell-ssh'
  filetype plugin indent on
" }}}

  " Behaviour {{{1
" ---------------------------------------------------------
  set backspace=indent,eol,start

  " Search
  set wrapscan
  set ignorecase
  set smartcase
  set incsearch
  set hlsearch
  set showmatch
  set gdefault

  set wildmenu
  set wildchar=<Tab>
  set wildmode=list:full
  set history=100
  set complete+=k
  set cmdheight=2

  set visualbell t_vb=
  set hidden
  set nojoinspaces
  set wildmode=longest,list
  set nrformats=

  if has('mouse')
    set mouse=a
    set guioptions+=a
    set ttymouse=xterm2
  endif

  set nobackup
  set noswapfile

  set autoindent
  "set paste
  set tabstop=2
  set softtabstop=2
  set shiftwidth=2
  set expandtab
  set foldmethod=indent

  set virtualedit+=block

  " Use os's clipboard
  set clipboard+=unnamed
" }}}

" Mappings {{{1
" ---------------------------------------------------------
  nnoremap ; :

  " Natural behavior with wordwrap on
  nnoremap j gj
  nnoremap k gk

  nmap <ESC><ESC> ;nohlsearch<CR><ESC>
  map <leader><space> :noh<CR>

  " insert mode
  imap  <C-e> <END>
  imap  <C-a> <HOME>

  " Enable vim navigation in insert mode
  imap <C-j> <Down>
  imap <C-k> <Up>
  imap <C-h> <Left>
  imap <C-l> <Right>

  " Buffers
  nnoremap <C-h> <C-w>h
  nnoremap <C-j> <C-w>j
  nnoremap <C-k> <C-w>k
  nnoremap <C-l> <C-w>l
  nnoremap <C-tab> <C-w><C-w>
  nnoremap <leader>v :vsp<CR><C-w>l
  nnoremap <leader>h :split<CR><C-w>j
  map <D-A-right> :bn<CR>
  map <D-A-left> :bp<CR>

  " Automatically move to last cursor position
  if has("autocmd")
    au BufReadPost * if line("'\"") > 0 && line("'\"") <= line("$") | exe "normal g`\"" | endif
  endif


  noremap <space> :call ToggleFold()<CR>

  " Fast escape insert mode
  "inoremap <Esc> <nop>
  inoremap jj <ESC>

  " Strip all trading whitespace in current while
  nmap <leader>W :%s/\s\+$//<CR>:let @/=''<CR>

  " HTML fold tag
  nmap <leader>f Vatzf

  " Sort css properties alphabetically
  nmap <leader>S ?{<CR>jV/^\s*\}?$<CR>k:sort<CR>:noh<CR>

  " Shortcut to rapidly toggle `set list`
  nmap <leader>i :set list!<CR>

  " Formatting, TextMate-style
  map <leader>Q gqip

  " Make shortcut
  nmap <leader>m :make<CR>

  " Save on losing focus
  "au focuslost * :wa

  " Disable help key
  map <F1> <nop>

  " Move current line down/up
  map <C-Up> dd<Up>P
  map <C-Down> ddp

  " Move visually selected lines down/up
  vmap <C-Down> xp`[V`]
  vmap <C-Up> x<Up>P`[V`]

  " Move visual selection back/forwards
  vmap <C-Left> x<BS>P`[v`]
  vmap <C-Right> x<Space>P`[v`]

  " Xcode header to implementation shortcut
  vmap <D-A-Up> :e %:p:s,.h$,.X123X,:s,.m$,.h,:s,.X123X$,.m,<CR>

  " Forgot sudo
  cmap w!! w !sudo tee % >/dev/null
" }}}

" Appearance {{{1
" ---------------------------------------------------------
  " Useful status information at bottom of screen
  set statusline=[%n]\ %<%.99f\ %h%w%m%r%y\ %{fugitive#statusline()}%{exists('*CapsLockStatusline')?CapsLockStatusline():''}%=%-16(\ %l,%c-%v\ %)%P
  set ruler
  set showcmd
  set laststatus=2
  set listchars=tab:▸\ ,eol:¬
  set number
  set numberwidth=8
  set cursorline
  " When the terminal has colors, enable syntax+search highlighting
  if &t_Co > 2 || has("gui_running")
    syntax on
    set hlsearch
  endif
" }}}

 " Syntax {{{1
" ---------------------------------------------------------
  au FileType make         setlocal ts=8 sts=8 sw=8 noet
  au FileType yaml         setlocal ts=2 sts=2 sw=2 et
  au FileType php          setlocal ts=4 sts=4 sw=4 noet foldmethod=syntax
  au FileType java         setlocal ts=4 sts=4 sw=4 et   foldmethod=syntax
  au FileType vim          setlocal ts=2 sts=2 sw=2 et
  au FileType html         setlocal ts=2 sts=2 sw=2 et
  au FileType css          setlocal ts=2 sts=2 sw=2 et   foldmethod=indent
  au FileType javascript   setlocal ts=4 sts=4 sw=4 et   foldmethod=indent
  au FileType sh           setlocal ts=2 sts=2 sw=2 et
  au FileType actionscript setlocal ts=2 sts=2 sw=2 et
  au FileType ruby         setlocal ts=2 sts=2 sw=2 et

  au BufNewFile,BufRead *.rss setfiletype xml
  au BufNewFile,BufRead *.thtml setfiletype php
  au BufNewFile,BufRead *.tpl setfiletype php
  au BufNewFile,BufRead *_spec.rb compiler rspec
  au BufNewFile,BufRead *.as setfiletype actionscript
 " }}}

" Plugin Settings {{{1
" ---------------------------------------------------------
  " NerdTree
  map <leader>n :NERDTreeToggle<CR>
  map <F1> :NERDTreeToggle<CR>
  "map <F2> :NERDTreeFind<CR>
  let NERDTreeWinSize = 30
  let NERDTreeQuitOnOpen = 1
  let NERDTreeShowBookmarks = 0
  let NERDTreeWinPos = "Right"

  " TagList
  let Tlist_Ctags_Cmd = '/usr/local/bin/ctags'
  let Tlist_Use_Right_Window = 1
  map <leader>5 :TlistToggle<CR>
  "map <F3> :TlistToggle<CR>

  " Ack
  map <leader>a :Ack<space>

  " Fugitive
  command! Gd :Gdiff
  command! Gc :Gcommit
  command! Gw :Gwrite
  command! Gs :Gstatus

  " Neocomplcache
  let g:neocomplcache_enable_at_startup = 1

  " Zen coding
  let g:user_zen_leader_key = '<c-e>'
  let g:use_zen_complete_tag = 1

  " Unite
  let g:unite_enable_start_insert=0
  nnoremap <silent> <leader>ub :<C-u>Unite buffer<CR>
  nnoremap <silent> <leader>uf :<C-u>UniteWithBufferDir -buffer-name=files file<CR>
  nnoremap <silent> <leader>ur :<C-u>Unite -buffer-name=register register<CR>
  nnoremap <silent> <leader>um :<C-u>Unite file_mru<CR>
  nnoremap <silent> <leader>uu :<C-u>Unite buffer file_mru<CR>
  nnoremap <silent> <leader>ua :<C-u>UniteWithBufferDir -buffer-name=files buffer file_mru bookmark file<CR>
  map <F2> <leader>uu

  "CommantT
  let g:CommandTMaxFiles=20000
  let g:CommandTMaxDepth=100
  nnoremap <silent> <Leader>t :CommandT<CR>
  nnoremap <silent> <Leader>b :CommandTBuffer<CR>
" }}}

" Functions {{{1
  " Close current buffer 
  function! <SID>BufcloseCloseIt()
    let l:currentBufNum = bufnr("%")
    let l:alternateBufNum = bufnr("#")
    if buflisted(l:alternateBufNum)
      buffer #
    else
      bnext
    endif
    if bufnr("%") == l:currentBufNum
      new
    endif
    if buflisted(l:currentBufNum)
      execute("bdelete! ".l:currentBufNum)
    endif
  endfunction

  " Toggle fold state between closed and opened.
  " If there is no fold at current line, just moves forward.
  " If it is present, reverse it's state.
  function! ToggleFold()
    if foldlevel('.') == 0
      normal! l
    else
      if foldclosed('.') < 0
        . foldclose
      else
        . foldopen
      endif
    endif
    " Clear status line
    echo
  endfun
" }}}
